{% extends 'drevo/base.html' %}
{% load mptt_tags %}
{% load static %}
{% block cssfiles %} <style type="text/css">
   TD, TH {
    padding: 5px;
    border: 2px solid;
   }
  </style>{% endblock %}

{% block title %}Знание: {{ znanie.name }}
{% endblock %}

{% block content %}

{% if pwe %}
<div style="margin-left: auto;margin-right: auto; text-align:center; display: flex;flex-direction: row;
justify-content: flex-start;">
    <div id="preotvet" style="width: 20%; margin-top: 50px;"></div>
    <p style="display: none" id="countqs" >{{ pwe|length}}</p>
    {% for vopros, otvets in pwe.items %}
    {% for a, b in pravotvet.items %}
    {% if vopros in a%}
    <div id='a' class="cont" style="display: none; width: 60%;">
        <p>Тест: {{ znanie.tz }}</p>
        <div class="checkboxgroup" id="{{a}}1">
            <h5 id="{{vopros}}" class='vopr' style="display: none">{{b|length}}</h5>
            <p>Вопрос: {{vopros}}</p>
            <p>Количество ответов {{b|length}}</p>
            {% for otvet in otvets %}
            {% if otvet in b %}
                <label>
                    <input type="checkbox"  onclick="return keyCounter(this.name)" name="{{vopros}}" value="1">
                    {{ otvet }}
                </label>
            {% else %}
                <label>
                    <input type="checkbox"  onclick="return keyCounter(this.name)" name="{{vopros}}" value="0">
                    {{ otvet }}
                </label>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% endfor %}
    {% endfor %}
</div>
<div  id="rezultat" style="display: none;text-align:center;">
    <p>Тест: {{ znanie.tz }}</p>
    <table border="1" align="center" width="60%">
			<thead>
				<tr>
					<th>Вопрос</th>
					<th>Оценка</th>
                    <th>Число баллов</th>
				</tr>
			</thead>
        <tbody>
    {%for vopros in pwe.keys %}
    {% for a, b in pravotvet.items %}
    {% if vopros in a%}
				<tr id="{{vopros}}2">
					<td id="question">{{vopros}}</td>
                    <td id="grade">Неудовлетворительно</td>
                    <td id="answer"><p style="margin: 0; display: inline;">0/</p>
                        <p class="Allotvets" style="margin: 0; display: inline;" align="right">{{b|length}}</p> </td>
				</tr>
    {% endif %}
    {% endfor %}
    {% endfor %}
        </tbody>
        </table>
    <p id="result1"></p>
    <p id="result2">Оценка теста: неудовлетворительно</p>
</div>

<div style="display: flex;justify-content: center;">
    <button id="kn_sl" onclick="sled_vopr();" >Следующий вопрос</button>
    <button id="rz" style="display: none;" ><a href="{{ znanie.get_absolute_url }}" style="color: black; text-decoration:none;">Повторить тест</a></button>
</div>

{% endif %}

{% endblock %}
{% block jsfiles %}
<script>

let b = document.getElementsByClassName('cont').length;
let res = document.getElementsByClassName('Allotvets');
let w = 0;

function showFirst() {
    document.getElementsByClassName('cont')[0].style.display = "block";
    preanswers = 'Ответы:<br>'
    for(let i = 1; i < b+1; i++){
        preanswers += "<span id="+i+">Ответ-"+i+"</span><br>";
    }
    document.getElementById('preotvet').innerHTML = preanswers;

    for(let f=0; f< res.length; f++){
        w+= +(res[f].textContent);
    }
}

showFirst();

let d = 0;
let step = 1;
let result = 0;

function sled_vopr(){
    var lst2 = Array.from(new Set(lst));
    if(lst2.length < step){
    document.getElementById(step).innerHTML = "<span style='color: red;'>Ответ-неверный</span>";
    lst.push('0'+step);
    console.log('#utton was clicked');
    }else if(lst2.length == step ){
        docs = document.getElementById(lst2[d]+'1');
        let doccc = +(docs.querySelector('.vopr').textContent);
        let docc = docs.querySelectorAll('input[type="checkbox"]');
        let p = [];
          for (let i=0; i<docc.length; i++) {
             if(docc[i].checked == true){
                p.push(+(docc[i].value));
             }
          }
        cer = p.reduce((partialSum, a) => partialSum + a, 0);
        result += cer;

        let trs = document.getElementById(lst2[d]+'2');

        let td = trs.querySelectorAll('td');
        if((~~((cer*100)/doccc)) > 90){
            td[1].innerHTML = "Отлично";
        }else if(90 >= (~~((cer*100)/doccc)) && (~~((cer*100)/doccc)) > 60){
            td[1].innerHTML = "Хорошо";
        }else if(60 >= (~~((cer*100)/doccc)) && (~~((cer*100)/doccc)) > 30){
            td[1].innerHTML = "Удовлетворительно";
        }
        td[2].innerHTML = cer+'/'+doccc;

        if(cer == doccc){
        document.getElementById(step).innerHTML = "<span style='color: green;'>Ответ-верный</span>";
        }else if(cer != doccc){
        document.getElementById(step).innerHTML = "<span style='color: red;'>Ответ-неверный</span>";
        }
        tabl = document.getElementById(lst2[d]+'2');
    }
    if(step < b-1){
    document.getElementsByClassName('cont')[d].style.display = "none";
    document.getElementsByClassName('cont')[step].style.display = "block";
    d += 1;
    step +=1;
    }else if(step==b-1){
    document.getElementsByClassName('cont')[d].style.display = "none";
    document.getElementsByClassName('cont')[step].style.display = "block";
    document.getElementById('kn_sl').innerHTML = 'Результат';
    d += 1;
    step +=1;
    }else if(step == b){
    document.getElementsByClassName('cont')[d].style.display = "none";
    document.getElementById('rezultat').style.display = 'block';
    document.getElementById('kn_sl').style.display = 'none';
    document.getElementById('preotvet').style.display = 'none';
    document.getElementById('rz').style.display = 'block';
    document.getElementById('result1').innerHTML = 'Всего: ' + result + '/' +w;
    if((~~((result*100)/w)) > 90){
        document.getElementById('result2').innerHTML = "Оценка теста: отлично";
    }else if(90 >= (~~((result*100)/w)) && (~~((result*100)/w)) > 60){
        document.getElementById('result2').innerHTML = "Оценка теста: хорошо";
    }else if(60 >= (~~((result*100)/w)) && (~~((result*100)/w)) > 30){
        document.getElementById('result2').innerHTML = "Оценка теста: удовлетворительно";
    }
    }
}

var lst = []
function keyCounter(vopros){
    lst.push(vopros)
	let a = document.getElementsByName(vopros);
	let b = 0;
	let limit =  +(document.getElementById(vopros).textContent);
	for(let i = 0; i < a.length; i++){
		if(a[i].checked==true){
			b = b +1;
		}
	}
	if(b>limit){
	return false
	}
}

</script>
{% endblock %}