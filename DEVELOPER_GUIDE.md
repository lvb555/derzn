# Как устроен процесс разработки

Код пишется в отдельных git-ветках. Ветка создается под задачу - новая задача, новая ветка.
Есть базовая ветка или основная (англ. thunk - транк) в которую мы по
завершению работы заливаем свое решение. В проекте дерево знания такая ветка
называется `develop`.

## Оформление кода или как писать понятно

При разработке нужно пользоваться общими правилами оформления кода, делая упор на простоту и читаемость.

Для общих правил можно воспользоваться
[энциклопедией](https://dvmn.org/encyclopedia/) devman, параграф "как чистить
код". В самой энциклопедии есть много информации и по Django, так что
рекомендовано к прочтению.

Так же есть [статья](https://habr.com/ru/post/467039/) по поводу как проверять
PR, но правила одни и теже что для написания, что для проверки.
> Ремарка: в статье упоминается CL (changelist, список изменений) вместо PR (pull
> request, запрос на слияние изменений).

### Комменты к коду

Дополнительно: когда пишите комментарии к коду, старайтесь отвечать на вопрос
"зачем и для чего этот код здесь?", а не "что он делает".

В противном случае мы видим такое:

```
# итерируемся по коллекции и выполняем обработку
for i in items:
    process(i)
```

Не говоря о том, что сам код имеет названия ужасные (слишком абстрактные), так
еще и комментарий просто повторяет код!

Лучше:

```
# чтобы пользователи получили уведомление о новом знании
for user in users:
    notify_about_new_knowledge(user)
```

Это же правило касается текста коммита.

### Тестирование

Перед тем как отдать свое решение команде, нужно протестировать свой код. Можно
сделать это вручную или же автоматические тесты. Автоматические (unit-тесты) предпочтительнее.


## создание PR и его review

Когда вы закончили разработку и провели все тесты, нужно создать PR.
Для этого нужно сначала запушить свою ветку на сервер, а затем зайти на
страницу [пулл-реквестов репозитория](https://github.com/lvb555/derzn/compare)
и в кнопке **compare** выбрать свою ветку, а в соседней (**base**) - выбрать
develop. Это значит, что вы создадите PR в котором ваши изменения будут
предложены для слияния с веткой `develop`. После этого нажать "Create pull
request".

В созданном PR стоит обратить внимание на следующее:
- в описании (большая область текста) должна быть ссылка на задачу, которую
  решает PR, если задача такая есть. Введя знак решетки (`#`) в поле ввода
  описания, будет преложено указать номер задачи. Потому, если ваша задача
  имеет номер например 201, то достаточно ввести `#201`
- в заголовке PR стоит своими словами или скопировать из задачи короткое
  пояснение, что за изменения вы предлагаете.

# Старт разработки

Есть два способа настройки проекта локально у себя на машине:
1. Через виртуальное окружение python (предпочтительно для новичков)
2. Через docker

## 1. Установка через виртуальное окружение python

(\*) - означает что можно упростить с помощью direnv. Подробнее в самом конце

## создать виртуальное окружение (\*)

```bash
python: python -m venv env
```

## активировать вирт. окружение (\*)
```bash
source env/bin/activate
```

## установить зависимости в вирт.окружение

```bash
pip install -r requirements.txt
```

## инициализировать тестовые переменные окружения (\*)

Это придется делать каждый раз, аналогично активации вирт.окружения.

```bash
export SECRET_KEY=asdaaskdw9u2r4lfkjd32
export DEBUG=true
export ALLOWED_HOSTS='*'
export DB_URL=sqlite:///db.sqlite3
export BASE_URL=/
export EMAIL_HOST=localhost
export EMAIL_PORT=5822
export EMAIL_HOST_USER=admin
export EMAIL_HOST_PASSWORD=somepass
export EMAIL_USE_TLS=false
export EMAIL_USE_SSL=false
```


## инициализировать БД

```
./manage.py makemigration && ./manage.py migrate
```

## загрузить начальные данные

```
./manage.py loaddata dump.json
```


Файл dump.json спросить в чате или искать в закрепах.


## (\*) [Direnv](https://direnv.net/)

TL;DR:
после установки `direnv` выполняем команду в каталоге проекта:
```bash
cat <<EOF > .envrc
layout python3
export SECRET_KEY=asdaaskdw9u2r4lfkjd32
export DEBUG=true
export ALLOWED_HOSTS='*'
export DB_URL=sqlite:///db.sqlite3
export BASE_URL=/
export EMAIL_HOST=localhost
export EMAIL_PORT=5822
export EMAIL_HOST_USER=admin
export EMAIL_HOST_PASSWORD=somepass
export EMAIL_USE_TLS=false
export EMAIL_USE_SSL=false
EOF
```

После этого разрашаем исполнение этого файла командой:
```
direnv allow .
```
Теперь можно поставить зависимости и все. Каджый раз когда вы зайдете в этот
каталог, будет активирован venv и установленны нужные переменные.

### развернутое пояснение
Данная утилита позволяет несколько упростить действия, требуемые для выполнения
на постоянной основе для конкретного проекта/каталога.

Идея проста - при заходе в каталог, `direnv` исполняет файл `./envrc`.

В Python мы используем virtual environment (venv) для разделения зависимостей
между проектами, потому при переключении между проектами, нужно деактивировать
старый venv и активировать текущий (для проекта).

Так же, в случае данного проекта, требуется инциализация многих переменных
(вы видели выше).


## 2. Установка через docker

В первую очередь вам нужно иметь на своей машине работающий docker, он вам пригодится не только для этого проекта, поэтому есть смысл разобраться в его установке. К сожалению, там есть ряд нетривиальных моментов, в первую очередь со включением виртуализации на своей OS. Инструкции [здесь](https://docs.docker.com/get-docker/) или в гугле.

Далее клонируете этот репозиторий.

Находите в телеграм чате derzn актуальный дамп базы в формате json, скачиваете себе в корневую папку проекта, переименовываете в dump.json.

В терминале: заходите в папку проекта, затем
```
docker-compose up -d --build
```
Должен скачаться, успешно собраться и запуститься docker образ виртуальной машины, в которой уже будет код нашего проекта. Если ошибок нет, то нужно запустить еще ряд команд для импорта базы данных:
```
docker exec -it derzn-python ./manage.py migrate
docker exec -it derzn-python ./manage.py loaddata dump.json
docker exec -it derzn-python ./manage.py changepassword admin
```
Обратите внимание, что если вы испольузуете OS Windows с Git Bash терминалом, вам придется добавлять команду winpty перед каждой докер-командой, т.е. например `winpty docker exec -it derzn-python ./manage.py migrate`

Теперь ваша настроенная база данных хранится в файле db.sqlite3 в корне проекта.

В целом проект настроен, можете его открывать по адресу http://localhost:8083

Теперь вы можете изменять файлы проекта, изменения будут видны докер-образом (применяться моментально к сайту).

Если по какой-то причине необходимо перезапустить проект, просто выполните команду `docker-compose up -d --build` снова.


## 3. Дополнительно

Для того, чтобы кодовая база была более однообразной, предлагается
использовать утилиты pre-commit с линтерами и форматтерами.
Установите `pre-commit`:
```bash
pip install pre-commit
pre-commit init
```
После этого, все измененные файлы перед коммитом будут проходить
проверку линтера `flake8` и форматирование утилитой `black`.
Как правило, это приводит к ошибке коммита, потому что `flake8` может сообщить
об ошибках в коде, а `black` выполнил переформатирование.
Потому, процесс коммита может выглядеть так:
```bash
git commit -m "fix issue"
git update && !!
```
`!!` это специальная команда `bash`: повтор предыдущей команды
(в этом случае - `git commit -m "fix issue"`).
Если же вы уверены, что все в порядке, flake8 ошибается, а `black`
форматирует неправильно, ~~страдайте во благо общества~~ можно воспользоваться
костылем:
```bash
git commit -nm "fix issue"
```
дополнительный параметр `-n` отменит все проверки. Это значит, что вы передаете
решение этих проблем другому.

В случае с `flake8` можно внести исключение конкретных ошибок в файл конфигурации
`.flake8`, но к этому стоит подходить с умом.


# Процесс проверки PR

## Как проверять

[статья](https://habr.com/ru/post/467039/) по этой теме.

> Ремарка: в статье упоминается CL (changelist, список изменений) вместо PR (pull
> request, запрос на слияние изменений).

Проверка PR не сильно сложнее чем написание оного. Более того, когда мы создаем
PR и когда мы его проверяем используются одни и те же правила. Самое важное при
проверке PR это фокусировка на самой задаче и логике, которую нужно было
написать. В этой части конечно правил уже меньше, т.к. все зависит
от проекта и его целей.

Если все сильно упростить:
- будьте вежливы. Вы проверяете чужую работу, потому нельзя к ней относиться
  принебрежительно. В то же время, не стоит принимать не глядя - возможно вам
  потом понадобиться что-то поправить в этом коде и будет проще, если он будет
  вам понятен
- Если код не понятен - обсудите это в PR, предложите свое именование
  переменных или алгоритм или всю реализацию в целом
- Не обращайте внимания на несоблюдение форматирования. Для этого есть
  автоматизированные инструменты.
